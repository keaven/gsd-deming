<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 4 Introduction to gsdmvn, gsDesign2, and simtrial | Group Sequential Design Under Non-Proportional Hazards</title>
<meta name="author" content="Keaven M. Anderson, Yilong Zhang, Nan Xiao, and Yujie Zhao">
<meta name="description" content="simtrial, gsDesign2 and gsdmvn are under development and hosted on GitHub/Merck. Below is the Github repo link to the source code simtrial: https://github.com/Merck/simtrial  gsDesign2:...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 4 Introduction to gsdmvn, gsDesign2, and simtrial | Group Sequential Design Under Non-Proportional Hazards">
<meta property="og:type" content="book">
<meta property="og:description" content="simtrial, gsDesign2 and gsdmvn are under development and hosted on GitHub/Merck. Below is the Github repo link to the source code simtrial: https://github.com/Merck/simtrial  gsDesign2:...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Introduction to gsdmvn, gsDesign2, and simtrial | Group Sequential Design Under Non-Proportional Hazards">
<meta name="twitter:description" content="simtrial, gsDesign2 and gsdmvn are under development and hosted on GitHub/Merck. Below is the Github repo link to the source code simtrial: https://github.com/Merck/simtrial  gsDesign2:...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Deming Conference Course, December 6, 2021">Group Sequential Design Under Non-Proportional Hazards</a>:
        <small class="text-muted">Deming Conference Course, December 6, 2021</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="background.html"><span class="header-section-number">1</span> Background</a></li>
<li><a class="" href="proportional-hazards.html"><span class="header-section-number">2</span> Proportional hazards</a></li>
<li><a class="" href="ahr.html"><span class="header-section-number">3</span> Average hazard ratio</a></li>
<li><a class="active" href="pkgs.html"><span class="header-section-number">4</span> Introduction to gsdmvn, gsDesign2, and simtrial</a></li>
<li class="book-part">Others tests</li>
<li><a class="" href="overview-other-tests.html"><span class="header-section-number">5</span> Overview</a></li>
<li><a class="" href="fixed-design.html"><span class="header-section-number">6</span> Fixed design</a></li>
<li><a class="" href="wlr.html"><span class="header-section-number">7</span> Weighted logrank test</a></li>
<li><a class="" href="wlr-boundary.html"><span class="header-section-number">8</span> Group sequential design boundary with weighted logrank test</a></li>
<li><a class="" href="maxcombo.html"><span class="header-section-number">9</span> MaxCombo test</a></li>
<li><a class="" href="maxcombo-boundary.html"><span class="header-section-number">10</span> Group sequential design boundary with MaxCombo test</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/keaven/gsd-deming">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="pkgs" class="section level1">
<h1>
<span class="header-section-number">4</span> Introduction to gsdmvn, gsDesign2, and simtrial<a class="anchor" aria-label="anchor" href="#pkgs"><i class="fas fa-link"></i></a>
</h1>
<p><code>simtrial</code>, <code>gsDesign2</code> and <code>gsdmvn</code> are under development and hosted on GitHub/Merck.
Below is the Github repo link to the source code</p>
<ul>
<li>
<code>simtrial</code>: <a href="https://github.com/Merck/simtrial" class="uri">https://github.com/Merck/simtrial</a>
</li>
<li>
<code>gsDesign2</code>: <a href="https://github.com/Merck/gsDesign2" class="uri">https://github.com/Merck/gsDesign2</a>
</li>
<li>
<code>gsdmvn</code>: <a href="https://github.com/Merck/gsdmvn" class="uri">https://github.com/Merck/gsdmvn</a>
</li>
</ul>
<div id="simtrial" class="section level2">
<h2>
<span class="header-section-number">4.1</span> <code>simtrial</code><a class="anchor" aria-label="anchor" href="#simtrial"><i class="fas fa-link"></i></a>
</h2>
<p>The R package <code>simtrial</code> targets on time-to-event trial simulation under the piecewise model.
It uses logrank and weighted logrank for analysis.
It can simulate both fixed and group sequential design, also potential to simulate adaptive design.
Its validation is near completion (thanks to AP colleagues and Amin Shirazi).</p>
<p>In <code>simtrial</code>, there are several functions to generate simulated datasets:</p>
<ul>
<li>
<code><a href="https://merck.github.io/simtrial/reference/simfix.html">simfix()</a></code>: Simulation of fixed sample size design for time-to-event endpoint</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/simfix2simPWSurv.html">simfix2simPWSurv()</a></code>: Conversion of enrollment and failure rates from <code><a href="https://merck.github.io/simtrial/reference/simfix.html">simfix()</a></code> to <code><a href="https://merck.github.io/simtrial/reference/simPWSurv.html">simPWSurv()</a></code> format</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/simPWSurv.html">simPWSurv()</a></code>: Simulate a stratified time-to-event outcome randomized trial</li>
</ul>
<p>There are also functions to cut data for analysis:</p>
<ul>
<li>
<code><a href="https://merck.github.io/simtrial/reference/cutData.html">cutData()</a></code>: Cut a dataset for analysis at a specified date</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/cutDataAtCount.html">cutDataAtCount()</a></code>: Cut a dataset for analysis at a specified event count</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/getCutDateForCount.html">getCutDateForCount()</a></code>: Get date at which an event count is reached</li>
</ul>
<p>Most importantly, there are functions for analysis:</p>
<ul>
<li>
<code><a href="https://merck.github.io/simtrial/reference/tenFH.html">tenFH()</a></code>: Fleming-Harrington weighted logrank tests</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/tenFHcorr.html">tenFHcorr()</a></code>: Fleming-Harrington weighted logrank tests plus correlations</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/tensurv.html">tensurv()</a></code>: Process survival data into counting process format</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/pMaxCombo.html">pMaxCombo()</a></code>: MaxCombo p-value</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/pwexpfit.html">pwexpfit()</a></code>: Piecewise exponential survival estimation</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/wMB.html">wMB()</a></code>: Magirr and Burman modestly weighted logrank tests</li>
</ul>
<p>In <code>simtrial</code>, there are reverse engineered datasets:</p>
<ul>
<li>
<code>Ex1delayedEffect</code>: Time-to-event data example 1 for non-proportional hazards working group</li>
<li>
<code>Ex2delayedEffect</code>: Time-to-event data example 2 for non-proportional hazards working group</li>
<li>
<code>Ex3curewithph</code>: Time-to-event data example 3 for non-proportional hazards working group</li>
<li>
<code>Ex4belly</code>: Time-to-event data example 4 for non-proportional hazards working group</li>
<li>
<code>Ex5widening</code>: Time-to-event data example 5 for non-proportional hazards working group</li>
<li>
<code>Ex6crossing</code>: Time-to-event data example 6 for non-proportional hazards working group</li>
<li>
<code>MBdelayed</code>: Simulated survival dataset with delayed treatment effect</li>
</ul>
</div>
<div id="gsdesign2" class="section level2">
<h2>
<span class="header-section-number">4.2</span> <code>gsDesign2</code><a class="anchor" aria-label="anchor" href="#gsdesign2"><i class="fas fa-link"></i></a>
</h2>
<p>The R package <code>gsDesign2</code> has the main functions listed as follows.</p>
<ul>
<li>
<code><a href="https://merck.github.io/gsDesign2/reference/AHR.html">AHR()</a></code>: Average hazard ratio under non-proportional hazards</li>
<li>
<code><a href="https://merck.github.io/gsDesign2/reference/eAccrual.html">eAccrual()</a></code>: Piecewise constant expected accrual</li>
<li>
<code><a href="https://merck.github.io/gsDesign2/reference/eEvents_df.html">eEvents_df()</a></code>: Expected events observed under piecewise exponential model</li>
<li>
<code><a href="https://merck.github.io/gsDesign2/reference/ppwe.html">ppwe()</a></code>: Estimate piecewise exponential cumulative distribution function</li>
<li>
<code><a href="https://merck.github.io/gsDesign2/reference/s2pwe.html">s2pwe()</a></code>: Approximate survival distribution with piecewise exponential distribution</li>
<li>
<code><a href="https://merck.github.io/gsDesign2/reference/tEvents.html">tEvents()</a></code>: Predict time at which a targeted event count is achieved</li>
</ul>
</div>
<div id="gsdmvn" class="section level2">
<h2>
<span class="header-section-number">4.3</span> <code>gsdmvn</code><a class="anchor" aria-label="anchor" href="#gsdmvn"><i class="fas fa-link"></i></a>
</h2>
<p>The R package <code>gsdmvn</code> extends the <span class="citation">Jennison and Turnbull (<a href="references.html#ref-JTBook" role="doc-biblioref">2000</a>)</span> computational model to non-constant treatment effects.
The bound supports functions include</p>
<ul>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_b.html">gs_b()</a></code>: direct input of bounds;</li>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_spending_bound.html">gs_spending_bound()</a></code>: spending function bounds.</li>
</ul>
<p>Besides, it covers three models for analysis.</p>
<ul>
<li>Average hazard ratio model (see detailed description in Section <a href="ahr.html#secAhr">3.2</a>)
<ul>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_power_ahr.html">gs_power_ahr()</a></code>: Power computation</li>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_design_ahr.html">gs_design_ahr()</a></code>: Design computations</li>
</ul>
</li>
<li>Weighted logrank model (see detailed description in Section <a href="wlr.html#wlr">7</a>)
<ul>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_power_wlr.html">gs_power_wlr()</a></code>: Power computation</li>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_design_wlr.html">gs_design_wlr()</a></code>: Design computations</li>
</ul>
</li>
<li>MaxCombo model (see detailed description in Section <a href="maxcombo.html#maxcombo">9</a>)
<ul>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_power_combo.html">gs_power_combo()</a></code>: Power computation</li>
<li>
<code><a href="https://merck.github.io/gsdmvn/reference/gs_design_combo.html">gs_design_combo()</a></code>: Design computations</li>
</ul>
</li>
</ul>
</div>
<div id="simulation" class="section level2">
<h2>
<span class="header-section-number">4.4</span> Simulation<a class="anchor" aria-label="anchor" href="#simulation"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we conduct three simulations.</p>
<p>The first simulation is to compare the simulated power and asymptotic power.
Specifically speaking, we compare the results from <code><a href="https://merck.github.io/gsdmvn/reference/gs_power_ahr.html">gsdmvn::gs_power_ahr()</a></code> with that from <code><a href="https://merck.github.io/simtrial/reference/simfix.html">simtrial::simfix()</a></code>.
The details of this simulation can be found in Section <a href="pkgs.html#secAhrSimSimfix">4.4.1</a>.</p>
<p>The second simulation is to compare the simulated power and asymptotic power.
Specifically speaking, we compare the results from <code><a href="https://merck.github.io/gsDesign2/reference/AHR.html">gsDesign2::AHR()</a></code> with that from <code><a href="https://merck.github.io/simtrial/reference/simPWSurv.html">simtrial::simPWSurv()</a></code>.
The details of this simulation can be found in Section <a href="pkgs.html#secAhrSimSimPWSurv">4.4.2</a>.</p>
<p>The third simulation is to compare the estimation of <span class="math inline">\(\beta\)</span> by MLE and weighted summation as in Section <a href="ahr.html#secAhr">3.2</a>.
The details of this simulation can be found in Section <a href="pkgs.html#secAhrSimMleWs">4.4.3</a>.</p>
<div id="secAhrSimSimfix" class="section level3">
<h3>
<span class="header-section-number">4.4.1</span> Simulation 1: Compare the IA power by <code>gs_power_ahr()</code> and simulation <code>sim_fix()</code><a class="anchor" aria-label="anchor" href="#secAhrSimSimfix"><i class="fas fa-link"></i></a>
</h3>
<p>This section compares the simulated power and asymptotic power.
The simulated power is calculated by <code><a href="https://merck.github.io/simtrial/reference/simfix.html">simtrial::simfix()</a></code>, and the asymptotic power is calculated by <code><a href="https://merck.github.io/gsdmvn/reference/gs_power_ahr.html">gsdmvn::gs_power_ahr()</a></code>.
To conduct the comparison, we first save the output of <code><a href="https://merck.github.io/simtrial/reference/simfix.html">simtrial::simfix()</a></code> by running the following code chunk.
After that, we simply load the simulation results and compare it with the asymptotic power.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gsDesign</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/simtrial/">simtrial</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/gsdmvn/">gsdmvn</a></span><span class="op">)</span>

<span class="co">## Set the enrollment rates</span>
<span class="va">my_enrollRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span>,
  rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">12</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">## Set the failure rates</span>
<span class="va">my_failRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fl">1</span>,
  failRate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">9</span>,
  hr <span class="op">=</span> <span class="fl">0.65</span>,
  dropoutRate <span class="op">=</span> <span class="fl">0.001</span>
<span class="op">)</span>
<span class="co">## Set the number of simulations</span>
<span class="va">my_nsim</span> <span class="op">&lt;-</span> <span class="fl">1e+5</span>

<span class="co">## Create a group sequential design for survival outcome</span>
<span class="va">my_gsSurv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsDesign/man/nSurv.html">gsSurv</a></span><span class="op">(</span>
  k <span class="op">=</span> <span class="fl">2</span>,
  test.type <span class="op">=</span> <span class="fl">1</span>,
  alpha <span class="op">=</span> <span class="fl">0.025</span>,
  beta <span class="op">=</span> <span class="fl">0.2</span>,
  astar <span class="op">=</span> <span class="fl">0</span>,
  timing <span class="op">=</span> <span class="fl">0.7</span>,
  sfu <span class="op">=</span> <span class="va">sfLDOF</span>,
  sfupar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,
  sfl <span class="op">=</span> <span class="va">sfLDOF</span>,
  sflpar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,
  lambdaC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">9</span>,
  hr <span class="op">=</span> <span class="fl">0.65</span>,
  hr0 <span class="op">=</span> <span class="fl">1</span>,
  eta <span class="op">=</span> <span class="fl">0.001</span>,
  gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">12</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span>,
  R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span>,
  S <span class="op">=</span> <span class="cn">NULL</span>,
  T <span class="op">=</span> <span class="cn">NULL</span>,
  minfup <span class="op">=</span> <span class="cn">NULL</span>,
  ratio <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span>

<span class="co"># Update my_gsSurv with gsDesign() to get integer event counts</span>
<span class="va">my_gsDesign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsDesign/man/gsDesign.html">gsDesign</a></span><span class="op">(</span>
  k <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">k</span>,
  test.type <span class="op">=</span> <span class="fl">1</span>,
  alpha <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">alpha</span>,
  beta <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">beta</span>,
  sfu <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">upper</span><span class="op">$</span><span class="va">sf</span>,
  sfupar <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">upper</span><span class="op">$</span><span class="va">param</span>,
  n.I <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">my_gsSurv</span><span class="op">$</span><span class="va">n.I</span><span class="op">)</span>,
  maxn.IPlan <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">my_gsSurv</span><span class="op">$</span><span class="va">n.I</span><span class="op">[</span><span class="va">my_gsSurv</span><span class="op">$</span><span class="va">k</span><span class="op">]</span><span class="op">)</span>,
  delta <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">delta</span>,
  delta1 <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">delta1</span>,
  delta0 <span class="op">=</span> <span class="va">my_gsSurv</span><span class="op">$</span><span class="va">delta0</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">my_simfix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://merck.github.io/simtrial/reference/simfix.html">simfix</a></span><span class="op">(</span> <span class="co"># Number of simulations to perform.</span>
  nsim <span class="op">=</span> <span class="va">my_nsim</span>,
  <span class="co"># Total sample size per simulation.</span>
  sampleSize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">my_gsSurv</span><span class="op">$</span><span class="va">eNC</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">my_gsSurv</span><span class="op">$</span><span class="va">eNE</span><span class="op">)</span><span class="op">)</span>,
  <span class="co"># A tibble with</span>
  <span class="co"># (1) strata specified in `Stratum`</span>
  <span class="co"># (2) probability (incidence) of each stratum in `p`.</span>
  strata <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Stratum <span class="op">=</span> <span class="st">"All"</span>, p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
  <span class="co"># Targeted event count for analysis.</span>
  <span class="co"># Here we only target on the 1st IA only.</span>
  targetEvents <span class="op">=</span> <span class="va">my_gsDesign</span><span class="op">$</span><span class="va">n.I</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
  <span class="co"># Vector of treatments to be included in each block</span>
  block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Experimental"</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
  <span class="co"># Piecewise constant enrollment rates by time period.</span>
  enrollRates <span class="op">=</span> <span class="va">my_enrollRates</span>,
  <span class="co"># Piecewise constant control group failure rates,</span>
  <span class="co"># hazard ratio for experimental vs control,</span>
  <span class="co"># and dropout rates by stratum and time period.</span>
  failRates <span class="op">=</span> <span class="va">my_failRates</span>,
  <span class="co"># `timingType` has up to 5 elements indicating different options for data cutoff.</span>
  <span class="co"># `timingType = 1`: uses the planned study duration</span>
  <span class="co"># `timingType = 2`: the time the targeted event count is achieved</span>
  <span class="co"># `timingType = 3`: the planned minimum follow-up after enrollment is complete</span>
  <span class="co"># `timingType = 4`: the maximum of planned study duration and targeted event count cuts (1 and 2)</span>
  <span class="co"># `timingType = 5`: the maximum of targeted event count and minimum follow-up cuts (2 and 3)</span>
  timingType <span class="op">=</span> <span class="fl">2</span>
<span class="op">)</span>
<span class="co"># Save the simulation data</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">my_gsDesign</span>, file <span class="op">=</span> <span class="st">"./data/simulation_gs_power_ahr_my_gsDesign.Rdata"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">my_simfix</span>, file <span class="op">=</span> <span class="st">"./data/simulation_gs_power_ahr_my_simfix.Rdata"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gsDesign</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/simtrial/">simtrial</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/gsdmvn/">gsdmvn</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"./data/simulation_gs_power_ahr_my_simfix.Rdata"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"./data/simulation_gs_power_ahr_my_gsDesign.Rdata"</span><span class="op">)</span>

<span class="co">## Set the enrollment rates</span>
<span class="va">my_enrollRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span>,
  rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">12</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">## Set the failure rates</span>
<span class="va">my_failRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fl">1</span>,
  failRate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">9</span>,
  hr <span class="op">=</span> <span class="fl">0.65</span>,
  dropoutRate <span class="op">=</span> <span class="fl">0.001</span>
<span class="op">)</span>
<span class="va">my_nsim</span> <span class="op">&lt;-</span> <span class="fl">1e+5</span>

<span class="co"># Calculate the simulated power at the 1st IA</span>
<span class="va">my_sim_IA_power</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">my_simfix</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">&lt;=</span> <span class="op">-</span><span class="va">my_gsDesign</span><span class="op">$</span><span class="va">upper</span><span class="op">$</span><span class="va">bound</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Calculate the power by gs_ahr_power() at the 1st IA</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://merck.github.io/gsdmvn/reference/gs_power_ahr.html">gs_power_ahr</a></span><span class="op">(</span>
  enrollRates <span class="op">=</span> <span class="va">my_enrollRates</span>,
  failRates <span class="op">=</span> <span class="va">my_failRates</span>,
  ratio <span class="op">=</span> <span class="fl">1</span>,
  events <span class="op">=</span> <span class="va">my_gsDesign</span><span class="op">$</span><span class="va">n.I</span>, <span class="co"># set number of events the same as my_gsDesign above from gsDesign()</span>
  analysisTimes <span class="op">=</span> <span class="cn">NULL</span>,
  binding <span class="op">=</span> <span class="cn">FALSE</span>,
  upper <span class="op">=</span> <span class="va">gs_spending_bound</span>,
  upar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sf <span class="op">=</span> <span class="fu">gsDesign</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/gsDesign/man/sfLDOF.html">sfLDOF</a></span>, total_spend <span class="op">=</span> <span class="fl">0.025</span>, param <span class="op">=</span> <span class="cn">NULL</span>, timing <span class="op">=</span> <span class="cn">NULL</span>, theta <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
  lower <span class="op">=</span> <span class="va">gs_spending_bound</span>,
  lpar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sf <span class="op">=</span> <span class="fu">gsDesign</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/gsDesign/man/sfLDOF.html">sfLDOF</a></span>, total_spend <span class="op">=</span> <span class="fl">0.2</span>, param <span class="op">=</span> <span class="cn">NULL</span>, timing <span class="op">=</span> <span class="cn">NULL</span>, theta <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
  test_upper <span class="op">=</span> <span class="cn">TRUE</span>,
  test_lower <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="va">my_ahr_IA_power</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">Probability</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"The power at the 1st IA by gs_power_ahr() is:"</span>, <span class="va">my_ahr_IA_power</span>, <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; The power at the 1st IA by gs_power_ahr() is: 0.4605649</code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"The power at the 1st IA by"</span>, <span class="va">my_nsim</span>, <span class="st">"simulation is:"</span>, <span class="va">my_sim_IA_power</span>, <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; The power at the 1st IA by 1e+05 simulation is: 0.46655</code></pre>
</div>
<div id="secAhrSimSimPWSurv" class="section level3">
<h3>
<span class="header-section-number">4.4.2</span> Simulation 2: Compare AHR by <code>gsDesign2::AHR()</code> and <code>simtrial::simPWSurv()</code><a class="anchor" aria-label="anchor" href="#secAhrSimSimPWSurv"><i class="fas fa-link"></i></a>
</h3>
<p>This section compares the simulated AHR and asymptotic AHR
The simulated power is calculated by <code><a href="https://merck.github.io/simtrial/reference/simPWSurv.html">simtrial::simPWSurv()</a></code>, and the asymptotic power is calculated by <code><a href="https://merck.github.io/gsDesign2/reference/AHR.html">gsDesign2::AHR()</a></code>.
To conduct the comparison, we first save the output of <code><a href="https://merck.github.io/simtrial/reference/simPWSurv.html">simtrial::simPWSurv()</a></code> by running the following code chunk.
After that, we simply load the simulation results and compare it with the asymptotic AHR</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/simtrial/">simtrial</a></span><span class="op">)</span>

<span class="co"># Set the sample size</span>
<span class="va">my_N</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="co"># Set the analysis time, i.e., there are 4 looks</span>
<span class="va">my_analysisTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">20</span>, <span class="fl">28</span>, <span class="fl">36</span><span class="op">)</span>
<span class="co"># Set the enrollment rates</span>
<span class="co"># This format of enrollment rates is design for simtrial::simfix()</span>
<span class="co"># If it is later used to simtrial::simPWSurv(),</span>
<span class="co"># function simtrial::simfix2simPWSurv() can used for transformation</span>
<span class="va">my_enrollRates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fl">12</span>,
  rate <span class="op">=</span> <span class="va">my_N</span> <span class="op">/</span> <span class="fl">12</span>
<span class="op">)</span>
<span class="co"># Set the failure rates</span>
<span class="co"># This format of failure rates is design for simtrial::simfix()</span>
<span class="co"># If it is later used to simtrial::simPWSurv(),</span>
<span class="co"># function simtrial::simfix2simPWSurv() can used for transformation</span>
<span class="va">my_failRates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">100</span><span class="op">)</span>,
  failRate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">15</span>,
  hr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.6</span><span class="op">)</span>,
  dropoutRate <span class="op">=</span> <span class="fl">0.001</span>
<span class="op">)</span>

<span class="co"># Set number of simulations</span>
<span class="va">my_nsim</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="co"># Set up matrix for simulation results</span>
<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">my_nsim</span> <span class="op">*</span> <span class="fl">4</span>, ncol <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sim"</span>, <span class="st">"Analysis"</span>, <span class="st">"Events"</span>, <span class="st">"beta"</span>, <span class="st">"var"</span>, <span class="st">"logrank"</span><span class="op">)</span>

<span class="co"># Set the index for results row</span>
<span class="va">ii</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">my_nsim</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Simulate a trial</span>
  <span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://merck.github.io/simtrial/reference/simPWSurv.html">simPWSurv</a></span><span class="op">(</span> <span class="co"># Generate my_N observations</span>
    n <span class="op">=</span> <span class="va">my_N</span>,
    <span class="co"># Use the same enrollRates as that in AHR</span>
    enrollRates <span class="op">=</span> <span class="va">my_enrollRates</span>,
    <span class="co"># Conversion of failRates from simfix() to simPWSurv() format</span>
    failRates <span class="op">=</span> <span class="fu"><a href="https://merck.github.io/simtrial/reference/simfix2simPWSurv.html">simfix2simPWSurv</a></span><span class="op">(</span><span class="va">my_failRates</span><span class="op">)</span><span class="op">$</span><span class="va">failRates</span>,
    <span class="co"># Conversion of dropoutRates from simfix() to simPWSurv() format</span>
    dropoutRates <span class="op">=</span> <span class="fu"><a href="https://merck.github.io/simtrial/reference/simfix2simPWSurv.html">simfix2simPWSurv</a></span><span class="op">(</span><span class="va">my_failRates</span><span class="op">)</span><span class="op">$</span><span class="va">dropoutRates</span>
  <span class="op">)</span>
  <span class="co"># For each generated my_N observations</span>
  <span class="co"># Go through pre-defined 4 looks</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">my_analysisTimes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Cut data at specified analysis times</span>
    <span class="co"># Use cutDataAtCount to cut at event count</span>
    <span class="co"># des is a dataset ready for survival analysis</span>
    <span class="va">dsc</span> <span class="op">&lt;-</span> <span class="va">ds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://merck.github.io/simtrial/reference/cutData.html">cutData</a></span><span class="op">(</span><span class="va">my_analysisTimes</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>

    <span class="co"># 1st column of results records the index of the simulation</span>
    <span class="va">results</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sim</span>
    <span class="co"># 2nd column of results records the index of the look</span>
    <span class="va">results</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">j</span>
    <span class="co"># 3rd column of results records the number of events</span>
    <span class="va">results</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dsc</span><span class="op">$</span><span class="va">event</span><span class="op">)</span>

    <span class="co"># Apply Cox model</span>
    <span class="va">cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">tte</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">Treatment</span>, data <span class="op">=</span> <span class="va">dsc</span><span class="op">)</span>
    <span class="co"># 4th column of results records the number log HR</span>
    <span class="va">results</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">cox</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span>
    <span class="co"># 5th column of results records the variance</span>
    <span class="va">results</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">cox</span><span class="op">$</span><span class="va">var</span><span class="op">)</span>

    <span class="co"># Logrank test</span>
    <span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">dsc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://merck.github.io/simtrial/reference/tensurv.html">tensurv</a></span><span class="op">(</span>txval <span class="op">=</span> <span class="st">"Experimental"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://merck.github.io/simtrial/reference/tenFH.html">tenFH</a></span><span class="op">(</span>rg <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>rho <span class="op">=</span> <span class="fl">0</span>, gamma <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
    <span class="co"># 5th column of results records the logrank</span>
    <span class="va">results</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">Z</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span>

    <span class="co"># Increate the row index</span>
    <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">ii</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">results</span>, file <span class="op">=</span> <span class="st">"./data/simulation_AHR_simPRSurv.Rdata"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Calculate the simulated AHR</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"./data/simulation_AHR_simPRSurv.Rdata"</span><span class="op">)</span>

<span class="co"># Distribution of Cox coefficient</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>, 
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Analysis</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">beta</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Distribution of Cox Coefficient by Analysis"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Analysis"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Cox coefficient"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="gsd-deming_files/figure-html/unnamed-chunk-60-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Variability of results</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>, <span class="va">Sim</span> <span class="op">&lt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Sim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Sim</span><span class="op">)</span>, Analysis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Analysis</span><span class="op">)</span><span class="op">)</span>, 
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Analysis</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">Sim</span>, col <span class="op">=</span> <span class="va">Sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">Analysis</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.6</span>, <span class="fl">1.1</span>, <span class="fl">.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"HR"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="gsd-deming_files/figure-html/unnamed-chunk-60-2.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Comparison of asymptotic vs simulation</span>
<span class="va">AHR_simulated</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Analysis</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>
    AHR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span>,
    Events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span>,
    info <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span>,
    info0 <span class="op">=</span> <span class="va">Events</span> <span class="op">/</span> <span class="fl">4</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">AHR</span>, <span class="va">Events</span>, <span class="va">info</span>, <span class="va">info0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">AHR_simulated</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AHR_sim"</span>, <span class="st">"Events_sim"</span>, <span class="st">"info_sim"</span>, <span class="st">"info0_sim"</span><span class="op">)</span>

<span class="co"># Calculate the AHR asymptotically</span>
<span class="co"># gsDesign2::AHR() uses asymptotic distribution</span>
<span class="co"># We will compare its outputs with the simulated outputs</span>
<span class="co"># The simulated outputs is calculated by simtrial::simPWSurv()</span>

<span class="co"># Set the sample size the same as simPWSurv()</span>
<span class="va">my_N</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="co"># Set the analysis time the same as simPWSurv()</span>
<span class="va">my_analysisTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">20</span>, <span class="fl">28</span>, <span class="fl">36</span><span class="op">)</span>
<span class="co"># Set the enrollment rates the same as simPWSurv()</span>
<span class="va">my_enrollRates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fl">12</span>,
  rate <span class="op">=</span> <span class="va">my_N</span> <span class="op">/</span> <span class="fl">12</span>
<span class="op">)</span>
<span class="co"># Set the failure rates the same as simPWSurv()</span>
<span class="va">my_failRates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  Stratum <span class="op">=</span> <span class="st">"All"</span>,
  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">100</span><span class="op">)</span>,
  failRate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">15</span>,
  hr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.6</span><span class="op">)</span>,
  dropoutRate <span class="op">=</span> <span class="fl">0.001</span>
<span class="op">)</span>

<span class="va">AHR_asymptotics</span> <span class="op">&lt;-</span> <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="https://merck.github.io/gsDesign2/reference/AHR.html">AHR</a></span><span class="op">(</span>
  enrollRates <span class="op">=</span> <span class="va">my_enrollRates</span>,
  failRates <span class="op">=</span> <span class="va">my_failRates</span>,
  totalDuration <span class="op">=</span> <span class="va">my_analysisTimes</span>,
  ratio <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">AHR_asymptotics</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Time"</span>, <span class="st">"AHR_asy"</span>, <span class="st">"Events_asy"</span>, <span class="st">"info_asy"</span>, <span class="st">"info0_asy"</span><span class="op">)</span>

<span class="co"># Compare the results</span>
<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">AHR_asymptotics</span>, <span class="va">AHR_simulated</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">gt</span><span class="fu">::</span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">gt</span><span class="fu">::</span><span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">9</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">gt</span><span class="fu">::</span><span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">7</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div id="ryebschbly" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#ryebschbly .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ryebschbly .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ryebschbly .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ryebschbly .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ryebschbly .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ryebschbly .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ryebschbly .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ryebschbly .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ryebschbly .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ryebschbly .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ryebschbly .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ryebschbly .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#ryebschbly .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ryebschbly .gt_from_md > :first-child {
  margin-top: 0;
}

#ryebschbly .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ryebschbly .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ryebschbly .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#ryebschbly .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ryebschbly .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#ryebschbly .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ryebschbly .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ryebschbly .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ryebschbly .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ryebschbly .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ryebschbly .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#ryebschbly .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ryebschbly .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#ryebschbly .gt_left {
  text-align: left;
}

#ryebschbly .gt_center {
  text-align: center;
}

#ryebschbly .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ryebschbly .gt_font_normal {
  font-weight: normal;
}

#ryebschbly .gt_font_bold {
  font-weight: bold;
}

#ryebschbly .gt_font_italic {
  font-style: italic;
}

#ryebschbly .gt_super {
  font-size: 65%;
}

#ryebschbly .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 65%;
}
</style>
<div class="inline-table"><table class="gt_table">
<thead class="gt_col_headings"><tr>
<th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">Time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">AHR_asy</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">Events_asy</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">info_asy</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">info0_asy</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">AHR_sim</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">Events_sim</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">info_sim</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">info0_sim</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_right">0.8395</td>
<td class="gt_row gt_right">107.39</td>
<td class="gt_row gt_right">26.3710</td>
<td class="gt_row gt_right">26.8486</td>
<td class="gt_row gt_right">0.8415</td>
<td class="gt_row gt_right">107.25</td>
<td class="gt_row gt_right">26.2593</td>
<td class="gt_row gt_right">26.8130</td>
</tr>
<tr>
<td class="gt_row gt_right">20</td>
<td class="gt_row gt_right">0.7379</td>
<td class="gt_row gt_right">207.90</td>
<td class="gt_row gt_right">50.6695</td>
<td class="gt_row gt_right">51.9741</td>
<td class="gt_row gt_right">0.7397</td>
<td class="gt_row gt_right">207.71</td>
<td class="gt_row gt_right">50.8936</td>
<td class="gt_row gt_right">51.9281</td>
</tr>
<tr>
<td class="gt_row gt_right">28</td>
<td class="gt_row gt_right">0.7000</td>
<td class="gt_row gt_right">279.10</td>
<td class="gt_row gt_right">68.2263</td>
<td class="gt_row gt_right">69.7759</td>
<td class="gt_row gt_right">0.7012</td>
<td class="gt_row gt_right">278.93</td>
<td class="gt_row gt_right">67.9878</td>
<td class="gt_row gt_right">69.7321</td>
</tr>
<tr>
<td class="gt_row gt_right">36</td>
<td class="gt_row gt_right">0.6832</td>
<td class="gt_row gt_right">331.29</td>
<td class="gt_row gt_right">81.3779</td>
<td class="gt_row gt_right">82.8227</td>
<td class="gt_row gt_right">0.6839</td>
<td class="gt_row gt_right">331.19</td>
<td class="gt_row gt_right">80.6198</td>
<td class="gt_row gt_right">82.7969</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="secAhrSimMleWs" class="section level3">
<h3>
<span class="header-section-number">4.4.3</span> Simulation 3: Compare <span class="math inline">\(\beta\)</span> by MLE and weighted summation<a class="anchor" aria-label="anchor" href="#secAhrSimMleWs"><i class="fas fa-link"></i></a>
</h3>
<p>This section compares the AHR estimated by MLE (see theoretical details in Section <a href="#secAhrMLE"><strong>??</strong></a>) and weighted summation (see theoretical details in Section <a href="#secAhrWeightedSum"><strong>??</strong></a>).</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com/">gt</a></span><span class="op">)</span>
<span class="va">my_nsim</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">my_nNewtonRaphson</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">compare_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">my_nsim</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">my_nsim</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Generate the number of change points, i.e., total number of timeline piece - 1</span>
  <span class="va">sim_M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">10</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">sim_d0_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">8</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">sim_d1_start</span> <span class="op">&lt;-</span> <span class="va">sim_d0_start</span> <span class="op">-</span> <span class="fl">3</span>
  <span class="va">sim_T0_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">20</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">sim_T1_start</span> <span class="op">&lt;-</span> <span class="va">sim_T0_start</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="co"># Generate simulated data</span>
  <span class="va">obs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span> <span class="co"># m = 1:5,</span>
    m <span class="op">=</span> <span class="va">sim_M</span>,
    <span class="co"># d0 = 4:8,</span>
    d0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sim_d0_start</span>, length.out <span class="op">=</span> <span class="va">sim_M</span><span class="op">)</span>,
    <span class="co"># d1 = 1:5,</span>
    d1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sim_d1_start</span>, length.out <span class="op">=</span> <span class="va">sim_M</span><span class="op">)</span>,
    <span class="co"># T0 = 10:14,</span>
    T0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sim_T0_start</span>, length.out <span class="op">=</span> <span class="va">sim_M</span><span class="op">)</span>,
    <span class="co"># T1 = 11:15</span>
    T1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sim_T1_start</span>, length.out <span class="op">=</span> <span class="va">sim_M</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      lambda0 <span class="op">=</span> <span class="va">d0</span> <span class="op">/</span> <span class="va">T0</span>,
      lambda1 <span class="op">=</span> <span class="va">d1</span> <span class="op">/</span> <span class="va">T1</span>,
      HR <span class="op">=</span> <span class="va">lambda1</span> <span class="op">/</span> <span class="va">lambda0</span>,
      <span class="co"># beta_m</span>
      gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">HR</span><span class="op">)</span>,
      <span class="co"># Var(beta_m)</span>
      vargamma <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">d0</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">d1</span>
    <span class="op">)</span>

  <span class="co"># Estimate beta by weighted summation</span>
  <span class="co"># beta = variable `logAHR`</span>
  <span class="va">estimate_beta_WS</span> <span class="op">&lt;-</span> <span class="va">obs_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
      wsum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">vargamma</span><span class="op">)</span>,
      <span class="co"># estimation of beta_WS</span>
      beta_WS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">gamma</span> <span class="op">/</span> <span class="va">vargamma</span><span class="op">)</span> <span class="op">/</span> <span class="va">wsum</span>,
      <span class="co"># variance of the estimation of beta_WS</span>
      var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">vargamma</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,
      <span class="co"># standard derivation of the estimation of beta_WS</span>
      se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>,
      <span class="co"># AHR: average of lambda_{1,m}/lambda_{0,m}</span>
      AHR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta_WS</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="va">compare_results</span><span class="op">[</span><span class="va">sim</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">estimate_beta_WS</span><span class="op">$</span><span class="va">beta_WS</span>

  <span class="co"># Estimate beta by MLE</span>
  <span class="va">beta_MLE</span> <span class="op">&lt;-</span> <span class="va">estimate_beta_WS</span><span class="op">$</span><span class="va">beta_WS</span>
  <span class="co"># beta_MLE_seq &lt;- beta_MLE    # ensure convergence</span>

  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">my_nNewtonRaphson</span><span class="op">)</span> <span class="op">{</span>
    <span class="co">## Calculate the first order derivative at the value of beta_k</span>
    <span class="va">temp_beta_d1</span> <span class="op">&lt;-</span> <span class="va">obs_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>beta_d1 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">d0</span> <span class="op">+</span> <span class="va">d1</span><span class="op">)</span> <span class="op">*</span> <span class="va">T1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta_MLE</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">T0</span> <span class="op">+</span> <span class="va">T1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta_MLE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
      <span class="op">+</span>
        <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d1</span><span class="op">)</span><span class="op">)</span>
    <span class="va">beta_d1_curr</span> <span class="op">&lt;-</span> <span class="va">temp_beta_d1</span><span class="op">$</span><span class="va">beta_d1</span>

    <span class="co">## Calculate the second order derivative at the value of beta_k</span>
    <span class="va">temp_beta_d2</span> <span class="op">&lt;-</span> <span class="va">obs_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>beta_d2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">T1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta_MLE</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">d0</span> <span class="op">+</span> <span class="va">d1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">T0</span> <span class="op">+</span> <span class="va">T1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta_MLE</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
      <span class="op">-</span>
        <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">d0</span> <span class="op">+</span> <span class="va">d1</span><span class="op">)</span> <span class="op">*</span> <span class="va">T1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta_MLE</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">T0</span> <span class="op">+</span> <span class="va">T1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta_MLE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">beta_d2_curr</span> <span class="op">&lt;-</span> <span class="va">temp_beta_d2</span><span class="op">$</span><span class="va">beta_d2</span>

    <span class="co">## Update beta by Newton-Raphson method, i.e.,</span>
    <span class="co">## beta_k+1 = beta_k - l'(beta_k)/l''(beta_k)</span>
    <span class="va">beta_MLE</span> <span class="op">&lt;-</span> <span class="va">beta_MLE</span> <span class="op">-</span> <span class="va">beta_d1_curr</span> <span class="op">/</span> <span class="va">beta_d2_curr</span>
    <span class="co"># beta_MLE_seq &lt;- c(beta_MLE_seq, beta_MLE)</span>
  <span class="op">}</span>

  <span class="va">compare_results</span><span class="op">[</span><span class="va">sim</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta_MLE</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">compare_results</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Weighted Summation"</span>, <span class="st">"MLE"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">compare_results</span>, file <span class="op">=</span> <span class="st">"./data/simulation_MLE_vs_WS.Rdata"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"./data/simulation_MLE_vs_WS.Rdata"</span><span class="op">)</span>
<span class="va">my_nsim</span> <span class="op">&lt;-</span> <span class="fl">1e+5</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">compare_results</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt;      Weighted Summation        MLE
#&gt; [1,]         -0.4139139 -0.4158463
#&gt; [2,]         -0.6729929 -0.6772665
#&gt; [3,]         -0.4203335 -0.4207679
#&gt; [4,]         -0.5409583 -0.5530679
#&gt; [5,]         -0.4247562 -0.4252013
#&gt; [6,]         -0.7252355 -0.7411065</code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span>
  <span class="st">"The MSE between MLE and weighted summation is "</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">compare_results</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">compare_results</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">my_nsim</span>, <span class="st">"\n"</span>
<span class="op">)</span></code></pre></div>
<pre><code>#&gt; The MSE between MLE and weighted summation is  4.464504e-05</code></pre>

</div>
</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="ahr.html"><span class="header-section-number">3</span> Average hazard ratio</a></div>
<div class="next"><a href="overview-other-tests.html"><span class="header-section-number">5</span> Overview</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#pkgs"><span class="header-section-number">4</span> Introduction to gsdmvn, gsDesign2, and simtrial</a></li>
<li><a class="nav-link" href="#simtrial"><span class="header-section-number">4.1</span> simtrial</a></li>
<li><a class="nav-link" href="#gsdesign2"><span class="header-section-number">4.2</span> gsDesign2</a></li>
<li><a class="nav-link" href="#gsdmvn"><span class="header-section-number">4.3</span> gsdmvn</a></li>
<li>
<a class="nav-link" href="#simulation"><span class="header-section-number">4.4</span> Simulation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#secAhrSimSimfix"><span class="header-section-number">4.4.1</span> Simulation 1: Compare the IA power by gs_power_ahr() and simulation sim_fix()</a></li>
<li><a class="nav-link" href="#secAhrSimSimPWSurv"><span class="header-section-number">4.4.2</span> Simulation 2: Compare AHR by gsDesign2::AHR() and simtrial::simPWSurv()</a></li>
<li><a class="nav-link" href="#secAhrSimMleWs"><span class="header-section-number">4.4.3</span> Simulation 3: Compare \(\beta\) by MLE and weighted summation</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/keaven/gsd-deming/blob/master/pkgs.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/keaven/gsd-deming/edit/master/pkgs.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Group Sequential Design Under Non-Proportional Hazards</strong>: Deming Conference Course, December 6, 2021" was written by Keaven M. Anderson, Yilong Zhang, Nan Xiao, and Yujie Zhao. It was last built on 2022-02-03.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
